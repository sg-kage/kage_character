<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <!-- iOS ホーム画面用アイコン -->
    <link rel="apple-touch-icon" href="image/kage.png">
    <!-- PCブラウザ用 favicon -->
    <link rel="icon" href="image/kage.png" type="image/png">
    <title>カゲマス図鑑</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">

    <!-- Google Tag Manager -->
    <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-XXXXXXX'); // ← ここに GTM コンテナID
    </script>
    <!-- End Google Tag Manager -->

    <style>
        body { background: #2E2E2E; color: #D3D3D3; font-family: 'Segoe UI', 'Meiryo', sans-serif; margin: 0; }
        h2 { margin: 0.6em 0 0.4em 0; font-size: 1.4em; text-align: center;}
        #container { display: flex; gap: 1em; margin: auto; padding: 1em; flex-wrap: wrap; }
        #side { min-width: 190px; flex: 1; }
        #main { flex: 2; min-width: 260px; }
        #filter, #attribute-row { margin: 0.3em 0; }
        #filter { width: 90%; font-size: 1em; margin-right: 0.5em; }
        #attribute-row { display: flex; gap: 0.5em; align-items: center; margin-bottom: 0.5em; }
        #attribute-btns { display: flex; gap: 0.5em; }
        .attr-btn { margin: 0; border: none; border-radius: 6px; padding: 0.5em 1.1em; font-size: 1em; font-weight: bold; cursor: pointer; color: #000 !important; transition: background 0.15s, color 0.15s, box-shadow 0.15s; }
        #hit-row { display: flex; align-items: center; gap: 0.8em; margin-bottom: 0.3em; }
        #hit-count { font-size: 1em; color: #fff; font-weight: bold; }
        #sort-btn { background: #888; color: #fff; border: none; border-radius: 6px; padding: 0.25em 0.9em; cursor: pointer; font-weight: normal; font-size: 1em; transition: background 0.15s, color 0.15s; margin-left: 0; }
        #sort-btn[aria-pressed="true"] { background: orange; color: #333; }
        #list { width: 100%; height: 50vh; max-height: 400px; font-size: 0.9em; border-radius: 6px; background: #444; color: #fff; padding: 0.2em 0.4em; overflow-y: auto; margin: 0; }
        #detail { margin-top: 0.5em; background: #333; color: #fff; border-radius: 8px; padding: 1em; min-height: 200px; box-shadow: 0 2px 8px #0007; font-size: 0.9em; width: 100%; max-width: 100%; box-sizing: border-box; }
        @media (max-width: 700px) { #container { flex-direction: column; } #side, #main { min-width: unset; width: 100%; } #list { height: 200px; } #detail { min-width: unset; width: 100%; } #attribute-row { flex-direction: column; gap: 0; align-items: flex-start; } #hit-row { flex-direction: column; align-items: flex-start; gap: 0.2em; } }
        .char-title { font-size: 1.3em; font-weight: bold; margin-bottom: 0.3em; color: #FFD700; text-align: center;}
        /* ここから詳細表示の見やすい改良 */
        .char-detail-wrap {
            background: #282828;
            border-radius: 10px;
            padding: 1em 1.4em 1.2em 1.4em;
            margin-bottom: 0.5em;
        }
        .char-basic {
            display: flex;
            flex-wrap: wrap;
            gap: 0.8em 1.5em;
            margin-bottom: 1.2em;
        }
        .char-basic-item {
            display: flex;
            align-items: center;
            gap: 0.5em;
            min-width: 120px;
        }
        .char-label {
            font-weight: bold;
            color: #FFD700;
            min-width: 4em;
            font-size: 1em;
        }
        .char-value {
            background: #444;
            border-radius: 5px;
            padding: 0.1em 0.7em;
            color: #fff;
            font-size: 1em;
            display: inline-block;
        }
        .attr-red { background: #FF6347 !important; color: #222 !important; }
        .attr-green { background: #32CD32 !important; color: #222 !important;}
        .attr-yellow { background: #FFD700 !important; color: #222 !important;}
        .attr-blue { background: #1E90FF !important; color: #fff !important;}
        .char-section {
            margin-bottom: 1em;
            background: #353535;
            border-radius: 7px;
            padding: 0.7em 1em 0.4em 1em;
            box-shadow: 0 2px 8px #0005;
        }
        .char-section-title {
            font-weight: bold;
            color: #7ad5ff;
            margin-bottom: 0.45em;
            font-size: 1.08em;
            border-left: 4px solid #7ad5ff;
            padding-left: 0.5em;
        }
        .char-section-content {
            color: #fff;
            line-height: 1.6;
            font-size: 0.98em;
        }
        /* ここまで詳細表示の見やすい改良 */
        .highlight { background: #555 !important; }
        .hit { color: #FF4444; font-weight: bold; }
        li.selected { background: #555; }
        ul#list { list-style: none; padding: 0; margin: 0; }
        ul#list li { padding: 0.2em 0.4em; cursor: pointer; border-radius: 4px; }
        ul#list li:hover { background: #666; }
        .creator-link { display: block; text-align: center; margin: 2.5em 0 1.2em 0; font-size: 1em; }
        .creator-link a { color: #1E90FF; text-decoration: none; font-weight: bold; }
        .creator-link a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-XXXXXXX"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <h2>カゲマス図鑑</h2>
    <div id="container">
        <div id="side">
            <input id="filter" type="text" placeholder="フィルター（スペース区切り）">
            <div id="attribute-row">
                <div id="attribute-btns"></div>
            </div>
            <div id="hit-row">
                <span id="hit-count"></span>
                <button id="sort-btn" aria-pressed="false">ポジ順</button>
            </div>
            <ul id="list"></ul>
        </div>
        <div id="main">
            <div id="detail"></div>
        </div>
    </div>
    <div class="creator-link">
        作成者: <a href="https://x.com/kagenotify" target="_blank" rel="noopener">kagenotify（X／旧Twitter）</a><br>
        Discord鯖: <a href="http://discord.gg/SfMWv5UPad" target="_blank" rel="noopener">陰マス通知</a>
    </div>

    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-F61RJCR09R');
    </script>

    <script>
        let characters = [];
        let positionSorted = false;
        let lastFiltered = [];
        let selectedIdx = 0;

        const attributes = {"赤": "#FF6347", "緑": "#32CD32", "黄": "#FFD700", "青": "#1E90FF"};
        const attrBtns = document.getElementById('attribute-btns');
        let excludedAttrs = new Set();

        for (const attr of ["赤","緑","黄","青"]) {
            const btn = document.createElement('button');
            btn.textContent = attr; btn.className = "attr-btn"; btn.style.background = attributes[attr];
            btn.onclick = () => { excludedAttrs.has(attr)?excludedAttrs.delete(attr):excludedAttrs.add(attr); updateAttrBtnColors(); updateList(true); };
            attrBtns.appendChild(btn);
        }
        function updateAttrBtnColors() { for (const attr of ["赤","緑","黄","青"]) { const btn = Array.from(attrBtns.children).find(b => b.textContent===attr); if(!btn) continue; btn.style.background = excludedAttrs.has(attr)?"#fff":attributes[attr]; } }
        updateAttrBtnColors();

        const sortBtn = document.getElementById('sort-btn');
        sortBtn.onclick = () => { positionSorted = !positionSorted; sortBtn.setAttribute("aria-pressed", positionSorted?"true":"false"); updateList(true); };

        document.getElementById('filter').addEventListener('input', function(){ updateList(true); });

        function highlightText(text, keywords){ if(Array.isArray(text)){ return text.map(t=>highlightText(t,keywords)).join('<br>'); } if(typeof text!=="string") return text; let result=text; keywords.forEach(k=>{ if(k&&result.toLowerCase().includes(k)){ const regexp=new RegExp(k.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'gi'); result=result.replace(regexp,m=>`<span class="hit">${m}</span>`); } }); return result; }
        function addSpaces(arr, filter){ return (arr||[]).map(item=>'　'+highlightText(item,filter)).join('<br>'); }
        function attributeClass(attr) {
            if (attr === "赤") return "attr-red";
            if (attr === "緑") return "attr-green";
            if (attr === "黄") return "attr-yellow";
            if (attr === "青") return "attr-blue";
            return "";
        }

        function updateList(resetSelect=false){
            const list = document.getElementById('list');
            const filterInput = document.getElementById('filter').value;
            const filter = filterInput.toLowerCase().split(/[ 　]+/).filter(k=>k);
            let filtered = characters.filter(char=>filter.every(k=>k===""||JSON.stringify(char).toLowerCase().includes(k)));
            if(excludedAttrs.size>0 && excludedAttrs.size<4){ filtered=filtered.filter(char=>!(char.attribute&&excludedAttrs.has(char.attribute))); }
            if(positionSorted){ filtered.sort((a,b)=>(parseInt(a.position)||999)-(parseInt(b.position)||999)); }
            lastFiltered=filtered;
            const hitCount=document.getElementById('hit-count'); hitCount.textContent=`ヒット件数: ${filtered.length}件`;
            list.innerHTML="";
            filtered.forEach((char,idx)=>{ const li=document.createElement('li'); li.innerHTML=highlightText(char.name,filter); li.onclick=()=>{ showDetail(char,filter); selectedIdx=idx; highlightSelected(); }; list.appendChild(li); });
            if(filtered.length){ if(resetSelect) selectedIdx=0; if(selectedIdx<0||selectedIdx>=filtered.length) selectedIdx=0; showDetail(filtered[selectedIdx],filter); highlightSelected(); } else{ showDetail(null); }
        }

        function highlightSelected(){ document.querySelectorAll('#list li').forEach((li,idx)=>{ li.classList.toggle('selected', idx===selectedIdx); }); }

        function showDetail(char, filter=[]){
            const detail=document.getElementById('detail');
            if(!char){
                detail.textContent="該当キャラクターがありません。";
                return;
            }
            function highlightDetail(val){ if(!val||!filter.length) return val; return highlightText(val,filter); }
            const attrColor=attributes[char.attribute]||"#fff";
            detail.innerHTML=`
                <div class="char-detail-wrap">
                  <div class="char-title" style="color: ${attrColor}">${highlightDetail(char.name)}</div>
                  <div class="char-basic">
                    <div class="char-basic-item"><span class="char-label">属性</span><span class="char-value ${attributeClass(char.attribute)}">${highlightDetail(char.attribute)}</span></div>
                    <div class="char-basic-item"><span class="char-label">ロール</span><span class="char-value">${highlightDetail(char.role)}</span></div>
                    <div class="char-basic-item"><span class="char-label">ポジション</span><span class="char-value">${highlightDetail(char.position)}</span></div>
                    <div class="char-basic-item"><span class="char-label">グループ</span><span class="char-value">${(char.group||[]).map(g=>highlightDetail(g)).join(', ')}</span></div>
                    <div class="char-basic-item"><span class="char-label">コンボ</span><span class="char-value">${highlightDetail(char.combo)}</span></div>
                    <div class="char-basic-item"><span class="char-label">覚醒</span><span class="char-value">${highlightDetail(char.arousal)}</span></div>
                  </div>
                  <div class="char-section">
                    <div class="char-section-title">特殊</div>
                    <div class="char-section-content">${addSpaces(char.traits,filter)}</div>
                  </div>
                  <div class="char-section">
                    <div class="char-section-title">特技1</div>
                    <div class="char-section-content">${addSpaces(char.skill1,filter)}</div>
                  </div>
                  <div class="char-section">
                    <div class="char-section-title">特技2</div>
                    <div class="char-section-content">${addSpaces(char.skill2,filter)}</div>
                  </div>
                  <div class="char-section">
                    <div class="char-section-title">奥義</div>
                    <div class="char-section-content">${addSpaces(char.ultimate,filter)}</div>
                  </div>
                  <div class="char-section">
                    <div class="char-section-title">魔道具1</div>
                    <div class="char-section-content">${addSpaces(char.magic_item1,filter)}</div>
                  </div>
                  <div class="char-section">
                    <div class="char-section-title">魔道具2</div>
                    <div class="char-section-content">${addSpaces(char.magic_item2,filter)}</div>
                  </div>
                </div>
            `;
        }

        document.addEventListener('keydown', function(e){ if(!lastFiltered.length) return; if(e.key==='ArrowDown'){ selectedIdx=Math.min(selectedIdx+1,lastFiltered.length-1); showDetail(lastFiltered[selectedIdx], getCurrentFilter()); highlightSelected(); e.preventDefault(); } if(e.key==='ArrowUp'){ selectedIdx=Math.max(selectedIdx-1,0); showDetail(lastFiltered[selectedIdx], getCurrentFilter()); highlightSelected(); e.preventDefault(); } });
        function getCurrentFilter(){ return document.getElementById('filter').value.toLowerCase().split(/[ 　]+/).filter(k=>k); }

        async function loadCharacters(){ try{ const resp=await fetch('characters/all_characters.json'); if(resp.ok){ characters=await resp.json(); updateList(true); } else{ document.getElementById('detail').innerText="キャラクターデータの取得に失敗しました"; } } catch(e){ document.getElementById('detail').innerText="キャラクターデータの取得に失敗しました"; } }
        loadCharacters();
    </script>
</body>
</html>